{% extends "ll_buildbike/base.html" %}

{% block bikebuilds %}
<div class="container">
  <div class="header-row">
    <h1>Bike Dashboard</h1>
    <div class="actions">
      <a href="{% url 'll_buildbike:bike_wizard' %}" class="btn btn-primary">Add a Bike</a>
      {# remove any form here that references c.bike.pk — c doesn't exist yet #}
    </div>
  </div>

  {% if cards %}
    <div class="bike-grid">
      {% for c in cards %}
  <article class="bike-card">
    <header class="bike-card__header">
      <div class="bike-card__title">
        <h2>{{ c.bike.bike_name|default:"Untitled Bike" }}</h2>
        {% if c.bike.is_default %}
          <span class="badge">Default</span>
        {% endif %}
        {% if c.bike.id in liked_ids %}❤️{% else %}♡{% endif %}
      </div>

      {% if c.bike.pk %}
        <form method="post" action="{% url 'bikedash:set_default_bike' c.bike.pk %}">
          {% csrf_token %}
          {% if not c.bike.is_default %}
            <button class="btn btn-light" type="submit">Set as Default</button>
          {% endif %}
        </form>
      {% endif %}
      <div class="actions">
        <a href="{% url 'll_buildbike:bike_wizard_edit' c.bike.pk %}" class="btn btn-light">Edit</a>
        <form method="post"
              action="{% url 'bikedash:delete_bike' c.bike.pk %}"
              style="display:inline"
              onsubmit="return confirm('Delete this bike and all its components/images?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </header>

    {# ⬇️ New integrated, clickable tile (replaces the old cover block) #}
    <a class="tile-link" href="{{ c.bike.get_absolute_url }}">
      {% if c.cover %}
        <img class="card__media" src="{{ c.cover }}" alt="{{ c.bike.bike_name|default:'Bike' }}">
      {% endif %}
      <div class="card__body">
        <h3 class="card__title">{{ c.bike.bike_name|default:"Untitled Bike" }}</h3>
        <div class="card__meta">
          by @{{ c.bike.owner.username|default:"anon" }} •
          {{ c.bike.bike_make }} {{ c.bike.bike_model }}
          {% if c.bike.bike_year %} • {{ c.bike.bike_year }}{% endif %}
          {% if c.bike.bike_build %} • {{ c.bike.bike_build }}{% endif %}
        </div>
      </div>
    </a>

    {% if c.gallery %}
      <div class="gallery">
        {% for url in c.gallery %}
          <img src="{{ url }}" alt="Bike photo {{ forloop.counter }}" class="thumb">
        {% endfor %}
      </div>
    {% endif %}

          {% if c.specs %}
            <section class="section">
              <h3>Bike Specs</h3>
              <dl class="kv">
                {% for row in c.specs %}
                  <div class="kv__row">
                    <dt>{{ row.label }}</dt>
                    <dd>{{ row.value }}</dd>
                  </div>
                {% endfor %}
              </dl>
            </section>
          {% endif %}

          {% for sec in c.sections %}
            <section class="section">
              <h3>{{ sec.title }}</h3>

              {% for instance_rows in sec.instances %}
                <dl class="kv">
                  {% for row in instance_rows %}
                    <div class="kv__row">
                      <dt>{{ row.label }}</dt>
                      <dd>
                        {% if row.is_url %}
                          <a href="{{ row.value }}" target="_blank" rel="noopener">View</a>
                        {% else %}
                          {{ row.value }}
                        {% endif %}
                      </dd>
                    </div>
                  {% endfor %}
                </dl>
                {% if not forloop.last %}<hr class="subdivider">{% endif %}
              {% endfor %}
            </section>
          {% endfor %}
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p>No bikes yet. <a href="{% url 'll_buildbike:bike_wizard' %}">Create one</a>.</p>
  {% endif %}
</div>

<style>
.container { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
.header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; gap: 1rem; }
.bike-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
.bike-card { border: 1px solid #e5e7eb; border-radius: .75rem; background: #fff; overflow: hidden; }
.bike-card__header { display: flex; align-items: center; justify-content: space-between; padding: .75rem 1rem; gap: .75rem; border-bottom: 1px solid #f0f0f0; }
.bike-card__title { display: flex; align-items: center; gap: .5rem; }
.badge { background: #0ea5e9; color: #fff; font-size: .75rem; padding: .15rem .4rem; border-radius: .35rem; }
.cover img { display: block; width: 100%; height: 220px; object-fit: cover; background: #f8fafc; }
.gallery { display: flex; gap: .5rem; padding: .5rem 1rem 0; flex-wrap: wrap; }
.gallery .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: .4rem; border: 1px solid #e5e7eb; background: #f8fafc; }
.section { padding: .75rem 1rem 1rem; }
.section h3 { margin: .25rem 0 .5rem; font-size: 1.05rem; }
.kv { margin: 0; }
.kv__row { display: grid; grid-template-columns: 1fr 2fr; gap: .5rem .75rem; padding: .25rem 0; }
.kv__row dt { color: #374151; font-weight: 600; }
.kv__row dd { margin: 0; color: #111827; }
.subdivider { border: 0; border-top: 1px dashed #e5e7eb; margin: .5rem 0; }
.btn { padding: .45rem .8rem; border-radius: .45rem; border: 1px solid #d1d5db; background: #f9fafb; cursor: pointer; }
.btn-primary { background: #0b6bcb; border-color: #0b6bcb; color: #fff; }
.btn-light { background: #fff; }
.actions { display: flex; gap: .5rem; }
.btn-danger { background: #dc2626; color: #fff; border-color: #dc2626; }
</style>
{% endblock %}




